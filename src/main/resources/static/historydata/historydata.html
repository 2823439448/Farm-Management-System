<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è®¾å¤‡å†å²æ•°æ®</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    <style>
        body {
            background-color: #f4f7f6;
        }
        .container-fluid {
            padding-top: 20px;
        }
        .card-header {
            background-color: #e9ecef;
            font-weight: bold;
        }
        .chart-container {
            /* è®¾å®šå›¾è¡¨å®¹å™¨é«˜åº¦ */
            height: 350px;
            position: relative;
        }
        /* åˆå§‹éšè—è¡¨æ ¼ */
        #historyTable {
            display: none;
        }
    </style>
</head>
<body>

<div class="container-fluid">
    <h2 class="mb-4">ğŸ“ˆ <span id="deviceNameDisplay">è®¾å¤‡</span> å†å²æ•°æ®</h2>

    <div class="card mb-4">
        <div class="card-header">æ•°æ®ç­›é€‰</div>
        <div class="card-body">
            <div class="row g-3 align-items-end">

                <div class="col-md-3">
                    <label for="deviceIdSelect" class="form-label">é€‰æ‹©è®¾å¤‡</label>
                    <select class="form-select" id="deviceIdSelect">
                        <option value="">æ­£åœ¨åŠ è½½è®¾å¤‡...</option>
                    </select>
                </div>

                <div class="col-md-3">
                    <label for="timeRangeSelect" class="form-label">å¿«é€Ÿé€‰æ‹©</label>
                    <select class="form-select" id="timeRangeSelect">
                        <option value="day" selected>è¿‘ 24 å°æ—¶</option>
                        <option value="week">è¿‘ 7 å¤©</option>
                        <option value="month">è¿‘ 30 å¤©</option>
                        <option value="all">æ‰€æœ‰æ•°æ® (çº¦ 2 å¹´)</option>
                    </select>
                </div>

                <div class="col-md-3">
                    <label for="granularitySelect" class="form-label">æ•°æ®ç²’åº¦/èšåˆ</label>
                    <select class="form-select" id="granularitySelect">
                        <option value="minute">åˆ† (åŸå§‹æ•°æ®)</option>
                        <option value="hour">æ—¶ (åŸå§‹æ•°æ®)</option>
                        <option value="day" selected>æ—¥ (æ—¥å¹³å‡)</option>
                        <option value="month">æœˆ (æœˆå¹³å‡)</option>
                        <option value="year">å¹´ (å¹´å¹³å‡)</option>
                    </select>
                </div>

                <div class="col-md-3">
                    <button class="btn btn-primary w-100" id="queryDataBtn">æŸ¥è¯¢æ•°æ®</button>
                </div>
            </div>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span>æ•°æ®æ›²çº¿å›¾</span>
            <div>
                <button class="btn btn-sm btn-outline-secondary me-2" id="resetZoomBtn">é‡ç½®ç¼©æ”¾</button>
                <button class="btn btn-sm btn-outline-info" id="toggleViewBtn">æŸ¥çœ‹æ•°æ®è¡¨</button>
            </div>
        </div>
        <div class="card-body">
            <div id="loadingIndicator" class="text-center p-5" style="display: none;">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">æ­£åœ¨åŠ è½½å†å²æ•°æ®...</p>
            </div>

            <h5 class="mt-2">æ¸©åº¦è¶‹åŠ¿ (Â°C)</h5>
            <div id="tempChartContainer" class="chart-container mb-4" style="display: none;">
                <canvas id="tempHistoryChart"></canvas>
            </div>

            <h5 class="mt-2">æ¹¿åº¦è¶‹åŠ¿ (%)</h5>
            <div id="humidChartContainer" class="chart-container mb-4" style="display: none;">
                <canvas id="humidHistoryChart"></canvas>
            </div>

            <h5 class="mt-2">å…‰ç…§è¶‹åŠ¿ (Lux)</h5>
            <div id="lightChartContainer" class="chart-container" style="display: none;">
                <canvas id="lightHistoryChart"></canvas>
            </div>

        </div>
    </div>

    <div class="card mb-4" id="historyTable">
        <div class="card-header">å†å²æ•°æ®è¡¨æ ¼</div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                    <tr>
                        <th>æ—¶é—´</th>
                        <th>æ¸©åº¦ (Â°C)</th>
                        <th>æ¹¿åº¦ (%)</th>
                        <th>å…‰ç…§ (Lux)</th>
                    </tr>
                    </thead>
                    <tbody id="historyTableBody">
                    <tr><td colspan="4" class="text-center">è¯·å…ˆæŸ¥è¯¢æ•°æ®</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // --- å…¨å±€å˜é‡ ---
    const API_URL = '/api/device-history';
    const DEVICE_LIST_API = '/api/myDevices';
    let tempHistoryChart = null;
    let humidHistoryChart = null;
    let lightHistoryChart = null; // âš ï¸ æ–°å¢ï¼šå…‰ç…§å›¾è¡¨å®ä¾‹


    // --- è¾…åŠ©å‡½æ•°ï¼šæ ¹æ®ç²’åº¦æ ¼å¼åŒ–æ—¶é—´ ---
    function formatTimeLabel(timestamp, granularity) {
        const date = new Date(timestamp);
        const year = date.getFullYear();
        const month = (date.getMonth() + 1).toString().padStart(2, '0');
        const day = date.getDate().toString().padStart(2, '0');
        const hour = date.getHours().toString().padStart(2, '0');
        const minute = date.getMinutes().toString().padStart(2, '0');
        const second = date.getSeconds().toString().padStart(2, '0');

        switch (granularity) {
            case 'minute':
                return `${month}-${day} ${hour}:${minute}:${second}`;
            case 'hour':
                return `${month}-${day} ${hour}:00`;
            case 'day':
                return `${year}-${month}-${day}`;
            case 'month':
                return `${year}-${month}`;
            case 'year':
                return `${year}`;
            default:
                return date.toLocaleString();
        }
    }

    // --- Chart.js åˆå§‹åŒ–å‡½æ•° (é€šç”¨) ---
    function initializeChart(chartId, labels, data, labelText, color, yAxisMin) {
        const ctx = document.getElementById(chartId);
        if (!ctx) return null;

        let chartInstance;
        // é”€æ¯æ—§å®ä¾‹ (æ ¹æ® ID é”€æ¯ç›¸åº”çš„å…¨å±€å˜é‡)
        if (chartId === 'tempHistoryChart' && tempHistoryChart) {
            tempHistoryChart.destroy();
        } else if (chartId === 'humidHistoryChart' && humidHistoryChart) {
            humidHistoryChart.destroy();
        } else if (chartId === 'lightHistoryChart' && lightHistoryChart) { // âš ï¸ æ–°å¢ï¼šå…‰ç…§å›¾è¡¨é”€æ¯
            lightHistoryChart.destroy();
        }

        chartInstance = new Chart(ctx.getContext('2d'), {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: labelText,
                        data: data,
                        borderColor: color,
                        backgroundColor: color.replace('rgb', 'rgba').replace(')', ', 0.5)'),
                        tension: 0.1,
                        pointRadius: 1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                plugins: {
                    title: { display: false },
                    legend: { display: false },
                    zoom: {
                        zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'x' },
                        pan: { enabled: true, mode: 'x' }
                    }
                },
                scales: {
                    x: { title: { display: true, text: 'æ—¶é—´' } },
                    y: {
                        type: 'linear', display: true, position: 'left',
                        title: { display: true, text: labelText, color: color },
                        min: yAxisMin,
                    }
                }
            }
        });

        return chartInstance;
    }

    // --- è·å–ç”¨æˆ·ç»‘å®šçš„è®¾å¤‡åˆ—è¡¨å¹¶å¡«å……ä¸‹æ‹‰æ¡† ---
    async function fetchDeviceList() {
        // ... (ä¿æŒä¸å˜)
        const selectEl = document.getElementById('deviceIdSelect');
        selectEl.innerHTML = '<option value="">æ­£åœ¨åŠ è½½è®¾å¤‡...</option>';

        try {
            const response = await fetch(DEVICE_LIST_API, {
                method: 'GET',
                credentials: 'include'
            });

            if (response.status === 401) {
                alert("âŒ é”™è¯¯ 401: æœªç™»å½•æˆ–ä¼šè¯è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•ã€‚");
                return [];
            } else if (!response.ok) {
                throw new Error(`HTTP é”™è¯¯! çŠ¶æ€ç : ${response.status}`);
            }

            const devices = await response.json();

            if (devices.length === 0) {
                selectEl.innerHTML = '<option value="">æœªç»‘å®šè®¾å¤‡</option>';
                document.getElementById('deviceNameDisplay').textContent = "æœªç»‘å®šè®¾å¤‡";
                return [];
            }

            selectEl.innerHTML = '';
            devices.forEach((device, index) => {
                const option = document.createElement('option');
                option.value = device.deviceId;
                option.textContent = `${device.deviceName} (ID: ${device.deviceId})`;
                if (index === 0) {
                    option.selected = true;
                }
                selectEl.appendChild(option);
            });

            document.getElementById('deviceNameDisplay').textContent =
                selectEl.options[selectEl.selectedIndex].text;

            return devices;

        } catch (error) {
            console.error("âŒ è·å–è®¾å¤‡åˆ—è¡¨å¤±è´¥:", error);
            selectEl.innerHTML = '<option value="">åŠ è½½è®¾å¤‡å¤±è´¥</option>';
            return [];
        }
    }


    // --- è·å–å†å²æ•°æ®å‡½æ•° (æ ¸å¿ƒä¿®æ”¹) ---
    async function fetchHistoryData() {
        const deviceSelectEl = document.getElementById('deviceIdSelect');
        const deviceId = deviceSelectEl.value;
        const timeRange = document.getElementById('timeRangeSelect').value;
        const granularity = document.getElementById('granularitySelect').value;

        if (!deviceId) {
            document.getElementById('loadingIndicator').style.display = 'none';
            alert("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè®¾å¤‡ã€‚");
            return;
        }

        // 1. æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨ï¼Œéšè—å›¾è¡¨å®¹å™¨
        document.getElementById('tempChartContainer').style.display = 'none';
        document.getElementById('humidChartContainer').style.display = 'none';
        document.getElementById('lightChartContainer').style.display = 'none'; // âš ï¸ æ–°å¢ï¼šå…‰ç…§å›¾è¡¨å®¹å™¨éšè—
        document.getElementById('loadingIndicator').style.display = 'block';
        document.getElementById('historyTableBody').innerHTML = `<tr><td colspan="4" class="text-center">æ­£åœ¨åŠ è½½...</td></tr>`;
        document.getElementById('deviceNameDisplay').textContent =
            deviceSelectEl.options[deviceSelectEl.selectedIndex].text;

        try {
            // 2. API è¯·æ±‚å‚æ•°
            const queryParams = new URLSearchParams({
                deviceId: deviceId,
                range: timeRange,
                granularity: granularity
            }).toString();

            const response = await fetch(`${API_URL}?${queryParams}`, {
                method: 'GET',
                credentials: 'include'
            });

            if (response.status === 401) {
                alert("âŒ é”™è¯¯ 401: æœªç™»å½•æˆ–ä¼šè¯è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•ã€‚");
                throw new Error("Unauthorized");
            } else if (response.status === 404) {
                alert("âŒ HTTP é”™è¯¯! çŠ¶æ€ç : 404ã€‚è¯·æ£€æŸ¥åç«¯ `/api/device-history` æ¥å£æ˜¯å¦æ­£ç¡®å¯åŠ¨å’Œæ˜ å°„ã€‚");
                throw new Error(`HTTP Error! Status: ${response.status}`);
            } else if (!response.ok) {
                alert(`âŒ HTTP é”™è¯¯! çŠ¶æ€ç : ${response.status}ã€‚è¯·æ£€æŸ¥åç«¯æ—¥å¿—ã€‚`);
                throw new Error(`HTTP Error! Status: ${response.status}`);
            }

            const historyData = await response.json();

            // 3. æ•°æ®å¤„ç†
            if (historyData.length === 0) {
                alert("âš ï¸ æœªæŸ¥è¯¢åˆ°å†å²æ•°æ®ã€‚è¯·æ£€æŸ¥æ•°æ®åº“æ˜¯å¦æœ‰è¯¥è®¾å¤‡çš„æ•°æ®æˆ–æ—¶é—´èŒƒå›´æ˜¯å¦æ­£ç¡®ã€‚");
                document.getElementById('historyTableBody').innerHTML = `<tr><td colspan="4" class="text-center">æœªæŸ¥è¯¢åˆ°æ•°æ®</td></tr>`;

                if (tempHistoryChart) tempHistoryChart.destroy();
                if (humidHistoryChart) humidHistoryChart.destroy();
                if (lightHistoryChart) lightHistoryChart.destroy(); // âš ï¸ æ–°å¢ï¼šé”€æ¯å…‰ç…§å›¾è¡¨

                return;
            }

            const timeLabels = [];
            const tempData = [];
            const humidityData = [];
            const lightData = []; // âš ï¸ æ–°å¢ï¼šå…‰ç…§æ•°æ®æ•°ç»„
            let tableRowsHtml = '';

            historyData.forEach(data => {
                const timeString = formatTimeLabel(data.timestamp, granularity);

                timeLabels.push(timeString);
                // ç¡®ä¿ null å€¼æ­£ç¡®å¤„ç†
                tempData.push(Number.isFinite(data.temperature) && data.temperature !== null ? data.temperature : null);
                humidityData.push(Number.isFinite(data.humidity) && data.humidity !== null ? data.humidity : null);
                lightData.push(Number.isFinite(data.light) && data.light !== null ? data.light : null); // âš ï¸ æ–°å¢ï¼šå¤„ç†å…‰ç…§æ•°æ®

                // å‡†å¤‡è¡¨æ ¼è¡Œæ•°æ®
                tableRowsHtml += `
                    <tr>
                        <td>${timeString}</td>
                        <td>${data.temperature !== undefined && data.temperature !== null ? data.temperature.toFixed(1) : '-'}</td>
                        <td>${data.humidity !== undefined && data.humidity !== null ? data.humidity.toFixed(0) : '-'}</td>
                        <td>${data.light !== undefined && data.light !== null ? data.light.toFixed(1) : '-'}</td>
                    </tr>
                `;
            });

            // 4. æ›´æ–°å›¾è¡¨å’Œè¡¨æ ¼ (åˆ†åˆ«åˆ›å»ºå’Œæ›´æ–°å›¾è¡¨)
            tempHistoryChart = initializeChart(
                'tempHistoryChart',
                timeLabels,
                tempData,
                'æ¸©åº¦ (Â°C)',
                'rgb(255, 99, 132)',
                0 // æœ€å°å€¼ä¸º 0ï¼Œæœ€å¤§å€¼è‡ªé€‚åº”
            );

            humidHistoryChart = initializeChart(
                'humidHistoryChart',
                timeLabels,
                humidityData,
                'æ¹¿åº¦ (%)',
                'rgb(54, 162, 235)',
                0 // æœ€å°å€¼ä¸º 0ï¼Œæœ€å¤§å€¼è‡ªé€‚åº”
            );

            // âš ï¸ æ–°å¢ï¼šåˆå§‹åŒ–å…‰ç…§å›¾è¡¨
            lightHistoryChart = initializeChart(
                'lightHistoryChart',
                timeLabels,
                lightData,
                'å…‰ç…§ (Lux)',
                'rgb(255, 205, 86)', // é€‰ç”¨é»„è‰²ç³»
                0 // æœ€å°å€¼ä¸º 0ï¼Œæœ€å¤§å€¼è‡ªé€‚åº”
            );

            document.getElementById('historyTableBody').innerHTML = tableRowsHtml;

        } catch (error) {
            console.error("âŒ è·å–å†å²æ•°æ®å¤±è´¥:", error);
            // ...
        } finally {
            // 5. éšè—åŠ è½½æŒ‡ç¤ºå™¨ï¼Œæ˜¾ç¤ºå›¾è¡¨å®¹å™¨
            document.getElementById('loadingIndicator').style.display = 'none';
            if (tempHistoryChart) document.getElementById('tempChartContainer').style.display = 'block';
            if (humidHistoryChart) document.getElementById('humidChartContainer').style.display = 'block';
            if (lightHistoryChart) document.getElementById('lightChartContainer').style.display = 'block'; // âš ï¸ æ–°å¢ï¼šæ˜¾ç¤ºå…‰ç…§å›¾è¡¨å®¹å™¨
        }
    }

    // --- äº‹ä»¶ç›‘å¬å™¨ ---
    document.addEventListener('DOMContentLoaded', async () => {
        // 1. åŠ è½½è®¾å¤‡åˆ—è¡¨
        const devices = await fetchDeviceList();

        // 2. å¦‚æœæˆåŠŸåŠ è½½äº†è®¾å¤‡ï¼Œåˆ™é»˜è®¤æŸ¥è¯¢ç¬¬ä¸€ä¸ªè®¾å¤‡çš„å®æ—¶æ•°æ®
        if (devices && devices.length > 0) {
            fetchHistoryData();
        }

        // ç»‘å®šæŸ¥è¯¢æŒ‰é’®äº‹ä»¶
        document.getElementById('queryDataBtn').addEventListener('click', fetchHistoryData);

        // ç»‘å®šåˆ‡æ¢è®¾å¤‡äº‹ä»¶
        document.getElementById('deviceIdSelect').addEventListener('change', fetchHistoryData);

        // ç»‘å®šåˆ‡æ¢ç²’åº¦äº‹ä»¶
        document.getElementById('granularitySelect').addEventListener('change', fetchHistoryData);

        // ç»‘å®šé‡ç½®ç¼©æ”¾æŒ‰é’®äº‹ä»¶
        document.getElementById('resetZoomBtn').addEventListener('click', () => {
            if (tempHistoryChart) {
                tempHistoryChart.resetZoom();
            }
            if (humidHistoryChart) {
                humidHistoryChart.resetZoom();
            }
            if (lightHistoryChart) { // âš ï¸ æ–°å¢ï¼šé‡ç½®å…‰ç…§å›¾è¡¨ç¼©æ”¾
                lightHistoryChart.resetZoom();
            }
        });

        // ç»‘å®šåˆ‡æ¢è§†å›¾æŒ‰é’®äº‹ä»¶
        document.getElementById('toggleViewBtn').addEventListener('click', (e) => {
            const tableEl = document.getElementById('historyTable');
            const buttonEl = e.target;

            if (tableEl.style.display === 'none') {
                tableEl.style.display = 'block';
                buttonEl.textContent = 'éšè—æ•°æ®è¡¨';
            } else {
                tableEl.style.display = 'none';
                buttonEl.textContent = 'æŸ¥çœ‹æ•°æ®è¡¨';
            }
        });
    });
</script>

</body>
</html>