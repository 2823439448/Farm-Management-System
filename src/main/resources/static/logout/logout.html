<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ³¨é”€ä¸è®¾å¤‡ç®¡ç†</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* 1. æ ¸å¿ƒä¿®æ”¹ï¼šè®¾ç½®å›ºå®šèƒŒæ™¯å›¾ç‰‡ */
        body {
            background-image: url('/images/logout.png'); /* æ‚¨çš„èƒŒæ™¯å›¾ç‰‡è·¯å¾„ */
            background-size: cover; /* é“ºæ»¡æ•´ä¸ªå±å¹• */
            background-repeat: no-repeat; /* ä¸é‡å¤ */
            background-attachment: fixed; /* å›ºå®šèƒŒæ™¯ï¼Œä¸éšå†…å®¹æ»šåŠ¨ */
            margin: 0;
            padding: 0;
            height: 100vh; /* ç¡®ä¿ body è‡³å°‘ä¸ºè§†å£é«˜åº¦ */
            display: flex;
            align-items: center; /* å‚ç›´å±…ä¸­ */
            justify-content: center; /* æ°´å¹³å±…ä¸­ */
        }

        /* 2. ä¸»å®¹å™¨è®¾ç½®åŠé€æ˜èƒŒæ™¯ */
        .container {
            width: 90%;
            max-width: 700px;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            background-color: rgba(255, 255, 255, 0.85); /* åŠé€æ˜ç™½è‰² */
        }

        .card {
            border: none;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .alert-message {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            display: none; /* é»˜è®¤éšè— */
        }
    </style>
</head>
<body>

<div class="container">
    <h2 class="text-center mb-4">ğŸšª è´¦æˆ·ä¸è®¾å¤‡æ³¨é”€ä¸­å¿ƒ</h2>

    <div id="messageBox" class="alert-message alert-info text-center"></div>

    <div class="card mb-4 p-3">
        <h3 class="card-title text-center text-primary">å®‰å…¨é€€å‡ºç³»ç»Ÿ</h3>
        <p class="text-center">è¿™å°†æ¸…é™¤æ‚¨çš„ç™»å½•çŠ¶æ€ï¼Œè¿”å›åˆ°ç™»å½•é¡µé¢ã€‚</p>
        <button id="logoutBtn" class="btn btn-primary w-100">ç«‹å³é€€å‡ºç™»å½•</button>
    </div>

    <div class="card mb-4 p-3 border-warning">
        <h3 class="card-title text-center text-warning">âš  åˆ é™¤å•ä¸ªè®¾å¤‡åŠå…¶æ•°æ®</h3>
        <p class="text-danger">**è­¦å‘Šï¼š** åˆ é™¤åï¼Œè¯¥è®¾å¤‡çš„æ‰€æœ‰å†å²ä¼ æ„Ÿå™¨æ•°æ®å°†**æ°¸ä¹…ä¸¢å¤±**ã€‚</p>
        <div class="mb-3">
            <label for="deviceIdSelect" class="form-label">é€‰æ‹©è¦åˆ é™¤çš„è®¾å¤‡:</label>
            <select id="deviceIdSelect" class="form-select">
                <option value="">-- è¯·åŠ è½½è®¾å¤‡åˆ—è¡¨ --</option>
            </select>
        </div>
        <button id="deleteDeviceBtn" class="btn btn-warning w-100">åˆ é™¤é€‰ä¸­è®¾å¤‡</button>
    </div>

    <div class="card p-3 border-danger">
        <h3 class="card-title text-center text-danger">ğŸš¨ å½»åº•æ³¨é”€ç”¨æˆ·è´¦æˆ·</h3>
        <p class="text-danger">**ä¸¥é‡è­¦å‘Šï¼š** æ­¤æ“ä½œå°†**æ°¸ä¹…åˆ é™¤**æ‚¨çš„ç”¨æˆ·è´¦æˆ·ã€æ‰€æœ‰ç»‘å®šè®¾å¤‡åŠå…¶äº§ç”Ÿçš„**å…¨éƒ¨æ•°æ®**ã€‚æ­¤æ“ä½œä¸å¯é€†ï¼</p>
        <button id="deleteUserBtn" class="btn btn-danger w-100">æ³¨é”€æˆ‘çš„è´¦æˆ· (éœ€å¯†ç ç¡®è®¤)</button>
    </div>

</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('logoutBtn').addEventListener('click', handleLogout);
        document.getElementById('deleteDeviceBtn').addEventListener('click', handleDeleteDevice);
        document.getElementById('deleteUserBtn').addEventListener('click', handleDeleteUser);
        fetchDeviceList();
    });

    /**
     * æ˜¾ç¤ºæ¶ˆæ¯æç¤º
     */
    function showMessage(msg, type) {
        const box = document.getElementById('messageBox');
        box.className = `alert-message text-center alert-${type === 'error' ? 'danger' : (type === 'success' ? 'success' : 'info')}`;
        box.textContent = msg;
        box.style.display = 'block';
        setTimeout(() => {
            box.style.display = 'none';
        }, 5000);
    }

    /**
     * è·å–ç”¨æˆ·ç»‘å®šçš„è®¾å¤‡åˆ—è¡¨å¹¶å¡«å……ä¸‹æ‹‰æ¡†
     */
    async function fetchDeviceList() {
        const selectEl = document.getElementById('deviceIdSelect');
        selectEl.innerHTML = '<option value="">-- æ­£åœ¨åŠ è½½... --</option>';

        try {
            const response = await fetch('/api/my-devices-for-logout');
            if (response.status === 401) {
                // æœªç™»å½•ï¼Œç›´æ¥è·³è½¬
                window.location.href = "/login/login.html";
                return;
            }
            const devices = await response.json();

            selectEl.innerHTML = '<option value="">-- è¯·é€‰æ‹©è¦åˆ é™¤çš„è®¾å¤‡ --</option>';
            if (devices && devices.length > 0) {
                devices.forEach(device => {
                    const option = document.createElement('option');
                    option.value = device.device_unique_id;
                    option.textContent = `${device.device_name} (${device.device_unique_id})`;
                    selectEl.appendChild(option);
                });
            } else {
                selectEl.innerHTML = '<option value="">-- å½“å‰æ— ç»‘å®šè®¾å¤‡ --</option>';
                document.getElementById('deleteDeviceBtn').disabled = true;
            }

        } catch (error) {
            console.error('åŠ è½½è®¾å¤‡åˆ—è¡¨å¤±è´¥:', error);
            selectEl.innerHTML = '<option value="">-- åŠ è½½è®¾å¤‡åˆ—è¡¨å¤±è´¥ --</option>';
            showMessage('åŠ è½½è®¾å¤‡åˆ—è¡¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–é‡æ–°ç™»å½•', 'error');
        }
    }

    // ... handleLogout & handleDeleteDevice ä¿æŒä¸å˜ ...

    /**
     * å¤„ç†å®‰å…¨é€€å‡ºç™»å½•
     */
    async function handleLogout() {
        if (!confirm('æ‚¨ç¡®å®šè¦å®‰å…¨é€€å‡ºç³»ç»Ÿå—ï¼Ÿ')) {
            return;
        }
        try {
            const response = await fetch('/api/logout', { method: 'POST' });
            if (response.ok) {
                showMessage('é€€å‡ºæˆåŠŸï¼Œæ­£åœ¨è·³è½¬...', 'success');
                setTimeout(() => { window.location.href = "/login/login.html"; }, 1000);
            } else {
                const data = await response.json();
                showMessage(data.message || 'é€€å‡ºç™»å½•å¤±è´¥', 'error');
            }
        } catch (error) {
            showMessage('ç½‘ç»œè¯·æ±‚é”™è¯¯ï¼Œæ— æ³•é€€å‡º', 'error');
        }
    }

    /**
     * å¤„ç†åˆ é™¤æŒ‡å®šè®¾å¤‡
     */
    async function handleDeleteDevice() {
        const selectEl = document.getElementById('deviceIdSelect');
        const deviceId = selectEl.value;

        if (!deviceId) {
            showMessage('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè¦åˆ é™¤çš„è®¾å¤‡ï¼', 'error');
            return;
        }

        if (!confirm(`æ‚¨ç¡®å®šè¦æ°¸ä¹…åˆ é™¤è®¾å¤‡ [${deviceId}] åŠå…¶æ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯é€†ï¼`)) {
            return;
        }

        try {
            const response = await fetch(`/api/delete-device/${deviceId}`, { method: 'DELETE' });
            const data = await response.json();

            if (response.ok) {
                showMessage(data.message, 'success');
                fetchDeviceList();
            } else {
                showMessage(data.message || 'åˆ é™¤è®¾å¤‡å¤±è´¥', 'error');
            }
        } catch (error) {
            showMessage('ç½‘ç»œè¯·æ±‚é”™è¯¯ï¼Œåˆ é™¤è®¾å¤‡å¤±è´¥', 'error');
        }
    }


    /**
     * â­ï¸ ä¿®æ­£ç‚¹ï¼šå¤„ç†æ³¨é”€ç”¨æˆ·è´¦æˆ·ï¼Œå¢åŠ å¯†ç ç¡®è®¤
     */
    async function handleDeleteUser() {
        if (!confirm('âš ï¸ æœ€ç»ˆç¡®è®¤ï¼šæ‚¨ç¡®å®šè¦æ°¸ä¹…æ³¨é”€æ‚¨çš„è´¦æˆ·å’Œæ‰€æœ‰å…³è”æ•°æ®å—ï¼Ÿæ•°æ®å°†æ— æ³•æ¢å¤ï¼')) {
            return;
        }

        const password = prompt('ä¸ºäº†å®‰å…¨ï¼Œè¯·åœ¨æ­¤è¾“å…¥æ‚¨çš„ç™»å½•å¯†ç ä»¥ç¡®è®¤æ³¨é”€æ“ä½œï¼š');
        if (!password) {
            showMessage('æœªè¾“å…¥å¯†ç ï¼Œæ³¨é”€æ“ä½œå·²å–æ¶ˆã€‚', 'info');
            return;
        }

        try {
            const response = await fetch('/api/delete-user', {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ password: password }) // ä¼ é€’å¯†ç 
            });

            const data = await response.json();

            if (response.ok) {
                showMessage('è´¦æˆ·æ³¨é”€æˆåŠŸï¼Œæ­£åœ¨è·³è½¬åˆ°ç™»å½•é¡µ...', 'success');
                // æˆåŠŸåè·³è½¬
                setTimeout(() => {
                    window.location.href = "/login/login.html";
                }, 2000);
            } else if (response.status === 403) {
                showMessage('æ³¨é”€å¤±è´¥ï¼šå¯†ç ä¸æ­£ç¡®ã€‚', 'error');
            } else {
                showMessage(data.message || 'æ³¨é”€ç”¨æˆ·å¤±è´¥', 'error');
            }
        } catch (error) {
            console.error('æ³¨é”€ç”¨æˆ·å¤±è´¥:', error);
            showMessage('ç½‘ç»œè¯·æ±‚é”™è¯¯ï¼Œæ³¨é”€å¤±è´¥', 'error');
        }
    }
</script>
</body>
</html>