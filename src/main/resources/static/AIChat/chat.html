<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI æ™ºèƒ½å†œåœºåŠ©æ‰‹</title>

    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f2f2f2;
            margin: 0;
            padding: 0;
        }

        #app {
            width: 100%;
            max-width: 800px;
            margin: auto;
            padding: 20px;
        }

        h2 {
            text-align: center;
            color: #333;
        }

        .chat-box {
            background: #fff;
            border-radius: 10px;
            padding: 20px;
            height: 500px;
            overflow-y: auto;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }

        .msg {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 8px;
            max-width: 80%;
            word-wrap: break-word;
        }

        .msg.user {
            background: #d1eaff;
            text-align: right;
            margin-left: auto;
        }

        .msg.bot {
            background: #e7e7e7;
        }

        /* ç¡®ä¿ç¡®è®¤æŒ‰é’®åœ¨ bot æ¶ˆæ¯ä¸­æ˜¾ç¤ºæ­£å¸¸ */
        .msg.bot .confirm-btn {
            background: #2ecc71;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            margin-top: 10px;
            cursor: pointer;
            display: block; /* ç‹¬å ä¸€è¡Œ */
            width: fit-content;
        }

        .input-area {
            margin-top: 15px;
            display: flex;
            gap: 10px;
        }

        input {
            flex: 1;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #aaa;
            font-size: 16px;
        }

        button {
            padding: 12px 20px;
            border: none;
            background: #4CAF50;
            color: white;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
        }
        button:hover {
            background: #45a049;
        }

        /* æç¤ºè¯æŒ‰é’® */
        .suggestions {
            margin: 10px 0;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .suggestions button {
            background: #2196F3;
            border-radius: 20px;
            padding: 8px 15px;
        }
        .suggestions button:hover {
            background: #1976D2;
        }
    </style>
</head>

<body>
<div id="app">
    <h2>ğŸŒ± æ™ºèƒ½å†œåœº AI åŠ©æ‰‹</h2>

    <div class="suggestions">
        <button onclick="sendMsg('åœŸè±†éœ€è¦ä»€ä¹ˆæ¸©åº¦æ¹¿åº¦ï¼Ÿ')">åœŸè±†æ¸©æ¹¿åº¦</button>
        <button onclick="sendMsg('è‰è“éœ€è¦ä»€ä¹ˆæ¸©åº¦æ¹¿åº¦ï¼Ÿ')">è‰è“æ¸©æ¹¿åº¦</button>
        <button onclick="sendMsg('é»„ç“œçš„æœ€ä½³æ¸©æ¹¿åº¦æ˜¯å¤šå°‘ï¼Ÿ')">é»„ç“œæ¸©æ¹¿åº¦</button>
    </div>

    <div class="chat-box" id="chatBox"></div>

    <div class="input-area">
        <input id="msgInput" type="text" placeholder="è¯·è¾“å…¥ä½ çš„æ¶ˆæ¯..." />
        <button onclick="sendMsg()">å‘é€</button>
    </div>
</div>

<script>
    const chatBox = document.getElementById("chatBox");
    const input = document.getElementById("msgInput");

    function addMsg(text, sender) {
        const div = document.createElement("div");
        div.className = "msg " + sender;
        div.innerText = text;
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    function sendMsg(text = null) {
        const msg = text || input.value.trim();
        if (!msg) return;

        addMsg(msg, "user");
        input.value = "";

        // ä½¿ç”¨çœŸå®çš„ API è°ƒç”¨
        fetch("/api/chat", {
            method: "POST",
            headers: { "Content-Type": "text/plain" },
            body: msg
        })
            .then(res => res.text())
            .then(answer => {
                addMsg(answer, "bot");
                // âš ï¸ å…³é”®ä¿®æ­£ï¼šè°ƒç”¨æ–°çš„å¤„ç†å‡½æ•°ï¼Œå®ƒå°†è´Ÿè´£è§£æå¹¶æ·»åŠ ç¡®è®¤æŒ‰é’®
                handleBotResponse(answer);
            })
            .catch(e => addMsg("è¯·æ±‚å¤±è´¥ï¼š" + e, "bot"));
    }

    // æ–°å¢ï¼šå¤„ç† Bot å›å¤ï¼Œè§£ææ¸©æ¹¿åº¦èŒƒå›´ï¼Œå¹¶æ˜¾ç¤ºç¡®è®¤æŒ‰é’®
    function handleBotResponse(answer) {
        // AI åç«¯è¿”å›æ ¼å¼ä¸º "æ¸©åº¦: XX-YYâ„ƒ\næ¹¿åº¦: ZZ%"
        // åŒ¹é…ï¼šæ¸©åº¦: åé¢è·Ÿä¸€ä¸ªç©ºæ ¼æˆ–æ²¡æœ‰ï¼Œå†è·Ÿä¸€ä¸ªæ•°å­—èŒƒå›´ï¼ˆå¯èƒ½å¸¦å°æ•°ï¼‰ï¼Œå†è·Ÿ â„ƒ
        const tempRangeMatch = answer.match(/æ¸©åº¦:\s*(\d+(\.\d+)?)\s*-\s*(\d+(\.\d+)?)\s*â„ƒ/);

        if (!tempRangeMatch) return;   // æ²¡è§£æåˆ°æ¸©åº¦èŒƒå›´å°±ä¸åšåç»­æ“ä½œ

        // æå–èŒƒå›´çš„ä¸Šé™å’Œä¸‹é™
        // tempRangeMatch[1] æ˜¯ç¬¬ä¸€ä¸ªæ•è·ç»„ï¼ˆæœ€å°å€¼ï¼‰ï¼ŒtempRangeMatch[3] æ˜¯ç¬¬äºŒä¸ªï¼ˆæœ€å¤§å€¼ï¼‰
        const minTemp = parseFloat(tempRangeMatch[1]);
        const maxTemp = parseFloat(tempRangeMatch[3]);

        // æå–ä¸€ä¸ªåˆé€‚çš„å•ä¸€ç›®æ ‡æ¸©åº¦ï¼šå–ä¸Šé™ä½œä¸ºè‡ªåŠ¨è®¾ç½®çš„ç›®æ ‡
        const temp = maxTemp.toFixed(1);

        // 1. åœ¨èŠå¤©æ¡†ä¸­æ·»åŠ ç¡®è®¤æç¤ºå’ŒæŒ‰é’®
        const confirmMsg = document.createElement("div");
        confirmMsg.className = "msg bot";
        confirmMsg.innerHTML = `
            <p>æ£€æµ‹åˆ°ä½œç‰©æœ€ä½³æ¸©æ¹¿åº¦å»ºè®®ã€‚</p>
            <p>æ‚¨æƒ³è®© **AI åŠ©æ‰‹è‡ªåŠ¨è®¾ç½®ç›®æ ‡æ¸©åº¦ä¸º ${temp}â„ƒ** (å–å»ºè®®èŒƒå›´çš„ä¸Šé™) å¹¶å‘é€å‡æ¸©æŒ‡ä»¤å—ï¼Ÿ</p>
            <button class="confirm-btn" onclick="confirmAndRedirect('${temp}')">
                âœ… ç¡®è®¤è‡ªåŠ¨è®¾ç½®å¹¶å‡æ¸©
            </button>
        `;
        chatBox.appendChild(confirmMsg);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    // ç”¨æˆ·ç‚¹å‡»ç¡®è®¤æŒ‰é’®åçš„æ“ä½œ
    function confirmAndRedirect(temp) {
        // 1. å­˜å‚¨ AI æ¨èçš„æ¸©åº¦å€¼
        localStorage.setItem("aiSetTemp", temp);

        // 2. å­˜å‚¨ä¸€ä¸ªæ ‡å¿—ï¼Œå‘Šè¯‰ index.html é¡µé¢éœ€è¦æ‰§è¡Œå‡æ¸©æ“ä½œ
        localStorage.setItem("aiAutoHeat", "true");

        // 3. æ‰§è¡Œè·³è½¬
        window.location.href = "/index/index.html";
    }

    input.addEventListener("keydown", e => {
        if (e.key === "Enter") sendMsg();
    });
</script>

</body>
</html>